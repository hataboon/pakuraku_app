<!-- app/views/recipes/new.html.erb -->
<div class="min-h-screen bg-gradient-to-b from-orange-50 to-white py-8">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
    <%= form_with url: recipes_path, method: :post, local: true, class: "space-y-8" do |form| %>
    <%# カレンダーセクション %>
    <div class="bg-white rounded-2xl shadow-lg border border-orange-100 overflow-hidden">
      <div class="p-6 border-b border-orange-100">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h2 class="text-2xl font-bold bg-gradient-to-r from-orange-600 to-orange-500 bg-clip-text text-transparent">献立カレンダー</h2>
          </div>

          <%# 月切り替えナビゲーション %>
          <div class="flex items-center space-x-2 bg-orange-50 rounded-xl p-1.5">
            <%= link_to new_recipe_path(date: @date.prev_month), 
                          class: "p-2 text-orange-600 hover:bg-orange-100 rounded-lg transition-all duration-200" do %>
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m15 18-6-6 6-6" />
            </svg>
            <% end %>

            <span class="px-4 py-1.5 text-sm font-medium text-orange-800">
              <%= l @date, format: :month_year %>
            </span>

            <%= link_to new_recipe_path(date: @date.next_month),
                          class: "p-2 text-orange-600 hover:bg-orange-100 rounded-lg transition-all duration-200" do %>
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m9 18 6-6-6-6" />
            </svg>
            <% end %>
          </div>
        </div>
      </div>

      <div class="p-4 sm:p-6">
        <div class="calendar-grid">
          <%# 曜日ヘッダー %>
          <div class="grid grid-cols-7 mb-4">
            <% t('date.abbr_day_names').each_with_index do |day_name, index| %>
            <div class="text-center py-3 text-sm font-medium
                            <%= index == 0 ? 'text-red-500' : 
                                index == 6 ? 'text-blue-500' : 
                                'text-gray-600' %>">
              <%= day_name %>
            </div>
            <% end %>
          </div>

          <%# カレンダー日付 %>
          <div class="grid grid-cols-7 gap-2 sm:gap-4">
            <% @start_date.wday.times do %>
            <div class="min-h-[120px]"></div>
            <% end %>
            <% (@start_date..@end_date).each do |date| %>
            <% has_meal_plan = @calendar_plans.any? { |p| p.date == date } %>
            <div class="relative bg-white rounded-xl border <%= date == Time.zone.today ? 'border-orange-300 ring-2 ring-orange-100' : 'border-gray-100' %> 
                            <%= has_meal_plan ? 'min-h-[240px]' : 'min-h-[120px]' %> p-3 hover:shadow-md transition-all duration-200">
              <%# 日付表示 %>
              <div class="flex justify-between items-center mb-3">
                <span class="text-base font-medium
                               <%= date.sunday? ? 'text-red-500' : 
                                   date.saturday? ? 'text-blue-500' : 
                                   'text-gray-900' %>
                               <%= date == Date.today ? 'font-bold' : '' %>">
                  <%= date.day %>
                </span>
              </div>

              <%# 食事時間ごとの献立表示 %>
              <div class="space-y-3">
                <% ["朝", "昼", "夜"].each do |time| %>
                <% meal_time = case time
                                     when "朝" then "morning"
                                     when "昼" then "afternoon"
                                     when "夜" then "evening"
                                     end %>
                <div class="space-y-2">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium
                                     <%= case meal_time
                                         when 'morning'  then 'bg-gradient-to-r from-orange-100 to-orange-50 text-orange-700'
                                         when 'afternoon' then 'bg-gradient-to-r from-yellow-100 to-yellow-50 text-yellow-700'
                                         when 'evening'   then 'bg-gradient-to-r from-indigo-100 to-indigo-50 text-indigo-700'
                                         end %>">
                      <%= time %>
                    </span>
                    <%= check_box_tag "selected_dates[#{date.strftime('%Y-%m-%d')}][]",
                                          meal_time,
                                          false,
                                          class: "h-4 w-4 text-orange-500 rounded border-gray-300 focus:ring-orange-500" %>
                  </div>

                  <% if plan = @calendar_plans.find { |p| p.date == date && p.meal_time == meal_time } %>
                  <% if plan.meal_plan.present? %>
                  <% meal_data = JSON.parse(plan.meal_plan) rescue nil %>
                  <div class="pl-2">
                    <div class="flex items-center justify-between gap-2">
                      <div class="flex items-center gap-1.5 min-w-0">
                        <span class="inline-block px-2 py-0.5 text-base font-medium bg-gradient-to-r from-emerald-100 to-emerald-50 text-emerald-700 rounded-full whitespace-nowrap">主菜</span>
                        <span class="text-xs text-gray-600 truncate"><%= meal_data&.dig("main") %></span>
                      </div>
                      <% if current_user.present? && plan.user_id == current_user.id %>
                      <%= link_to calendar_plan_path(plan),
                                              data: {
                                                turbo_method: :delete,
                                                turbo_confirm: "この献立を削除してもよろしいですか？"
                                              },
                                              class: "p-1.5 rounded-full hover:bg-red-50 group transition-colors" do %>
                      <svg class="w-4 h-4 text-red-400 group-hover:text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6" />
                      </svg>
                      <% end %>
                      <% end %>
                    </div>
                    <div class="flex items-center gap-1.5 mt-1.5">
                      <span class="inline-block px-2 py-0.5 text-base font-medium bg-gradient-to-r from-amber-100 to-amber-50 text-amber-700 rounded-full whitespace-nowrap">副菜</span>
                      <span class="text-xs text-gray-600 truncate"><%= meal_data&.dig("side") %></span>
                    </div>
                  </div>
                  <% end %>
                  <% end %>
                </div>
                <% end %>
              </div>
            </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%# カテゴリー選択セクション %>
    <div class="bg-white rounded-2xl shadow-lg border border-orange-100 overflow-hidden">
      <div class="p-6">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-orange-500 bg-clip-text text-transparent mb-4">料理のカテゴリー（任意）</h2>
        <p class="text-sm text-gray-600 mb-6">選択しない場合、バランスの良い組み合わせで自動的に決定されます</p>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          <% Recipe::CATEGORIES.each do |key, value| %>
          <div class="form-check flex items-center bg-gradient-to-r from-orange-50 to-white p-3 rounded-xl border border-orange-100 hover:border-orange-300 hover:shadow-sm transition-all duration-200">
            <%= radio_button_tag "category", 
                                key, 
                                false, 
                                id: "category_#{key}", 
                                class: "form-check-input w-5 h-5" %>
            <%= label_tag "category_#{key}", 
                             value, 
                             class: "ml-3 text-base cursor-pointer flex-grow text-gray-700" %>
          </div>
          <% end %>
          <div class="form-check flex items-center bg-gradient-to-r from-orange-50 to-white p-3 rounded-xl border border-orange-100 hover:border-orange-300 hover:shadow-sm transition-all duration-200">
            <%= radio_button_tag "category", 
                            "", 
                            true, 
                            id: "category_none", 
                            class: "form-check-input w-5 h-5" %>
            <%= label_tag "category_none", 
                         "選択解除", 
                         class: "ml-3 text-base cursor-pointer flex-grow text-gray-700" %>
          </div>
        </div>
      </div>
    </div>

    <%# 栄養素選択セクション %>
    <div class="bg-white rounded-2xl shadow-lg border border-orange-100 overflow-hidden">
      <div class="p-6">
        <h2 class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-orange-500 bg-clip-text text-transparent mb-4">栄養素を選択</h2>

        <%# 主菜の栄養素選択 %>
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">主菜の栄養素（必須）</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
            <% ["ミネラル", "たんぱく質", "炭水化物", "ビタミン", "脂質"].each do |nutrient| %>
            <label for="main_nutrient_<%= nutrient %>" class="form-check flex items-center bg-gradient-to-r from-orange-50 to-white p-3 rounded-xl border border-orange-100 hover:border-orange-300 hover:shadow-sm transition-all duration-200 cursor-pointer">
              <%= check_box_tag "main_nutrients[]", nutrient, false, 
                          id: "main_nutrient_#{nutrient}", 
                          class: "form-check-input w-5 h-5" %>
              <span class="ml-3 text-base flex-grow text-gray-700"><%= nutrient %></span>
            </label>
            <% end %>
          </div>
        </div>

        <%# 副菜の栄養素選択 %>
        <div>
          <h3 class="text-xl font-semibold text-gray-800 mb-4">副菜の栄養素（任意）</h3>
          <p class="text-sm text-gray-600 mb-4">選択しない場合、主菜の栄養バランスを考慮して自動的に決定されます</p>

          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
            <% ["ミネラル", "たんぱく質", "炭水化物", "ビタミン", "脂質"].each do |nutrient| %>
            <label for="side_nutrient_<%= nutrient %>" class="form-check flex items-center bg-gradient-to-r from-orange-50 to-white p-3 rounded-xl border border-orange-100 hover:border-orange-300 hover:shadow-sm transition-all duration-200 cursor-pointer">
              <%= check_box_tag "side_nutrients[]", 
                              nutrient, 
                              false, 
                              id: "side_nutrient_#{nutrient}", 
                              class: "form-check-input w-5 h-5" %>
              <span class="ml-3 text-base flex-grow text-gray-700"><%= nutrient %></span>
            </label>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%# 送信ボタン %>
    <div class="mt-8 flex justify-center">
      <%= form.submit '献立を生成する', 
                        class: 'w-full sm:w-auto inline-flex items-center justify-center px-8 py-4 text-base font-medium rounded-xl text-white bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 shadow-lg shadow-orange-200 transform hover:-translate-y-0.5 transition-all duration-200' %>
    </div>
    <% end %>
  </div>
</div>